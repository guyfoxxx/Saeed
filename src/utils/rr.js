import { getCfg, rrKey } from "./kv.js"; function splitList(s){ return String(s||"").split(",").map(x=>x.trim()).filter(Boolean); } export async function nextToken(env,name){ const envStr=name==="OPENAI"?env.OPENAI_KEY:name==="HF"?env.HF_TOKEN:name==="OR"?env.OPENROUTER_KEY:null; let tokens=splitList(envStr); const kvStr=await getCfg(env,`TOKENS.${name}`); if(kvStr) tokens=splitList(kvStr); if(!tokens.length) return null; const key=rrKey(name); const raw=await env.CFG_DB.get(key); let idx=raw?Number(raw):0; if(!(idx>=0)) idx=0; const tok=tokens[idx%tokens.length]; await env.CFG_DB.put(key,String((idx+1)%tokens.length)); return tok; }