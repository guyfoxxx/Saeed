import { sendMessage, sendPhoto } from "../utils/telegram.js"; import { wantsImage, wikiFetchAndSend, handleSchematic } from "./handlers/image-fetch.js"; import { aiAnswerText, aiAnswerVision } from "./handlers/fallback.js"; import { handleCommand } from "./commands.js";
async function getFileUrl(token,file_id){ const r=await fetch(`https://api.telegram.org/bot${token}/getFile?file_id=${file_id}`); const j=await r.json(); const path=j?.result?.file_path; return path?`https://api.telegram.org/file/bot${token}/${path}`:null; }
export async function handleTelegramWebhook(update, env){ const token=env.TELEGRAM_BOT_TOKEN; const msg=update?.message; if(!msg) return new Response("no message",{status:200}); const chatId=msg.chat.id;
if(msg.photo&&msg.photo.length){ const photo=msg.photo[msg.photo.length-1]; const url=await getFileUrl(token,photo.file_id); const prompt="Ø§Ø¬Ø²Ø§ÛŒ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ Ø¯Ø§Ø®Ù„ ØªØµÙˆÛŒØ± Ø±Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ú©Ù† Ùˆ Ù†Ø§Ù… Ø¨Ø¨ÙØ±. Ø§Ú¯Ø± Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÛŒØŒ Ø¨Ú¯Ùˆ Ù…Ø­ØªÙ…Ù„ Ø§Ø³Øª."; const res=await aiAnswerVision(url,prompt,env); await sendMessage(token,chatId,"ğŸ” ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ±:\n"+res); return new Response("ok",{status:200}); }
const text=msg.text?.trim(); if(!text) return new Response("ok",{status:200});
if(text.startsWith("/")){ const res=await handleCommand(text,chatId,env); await sendMessage(token,chatId,res); return new Response("ok",{status:200}); }
if(/(Ù…Ø¯Ø§Ø±|schematic)/i.test(text)){ const r=await handleSchematic(text,env); if(r?.pngUrl){ await sendPhoto(token,chatId,r.pngUrl,"ğŸ“ Ø´Ù…Ø§ØªÛŒÚ© (PNG)"); } else if(r?.svgText){ await sendMessage(token,chatId,"ğŸ“ Ø´Ù…Ø§ØªÛŒÚ© (SVG):\n```\n"+r.svgText+"\n```"); } else { await sendMessage(token,chatId,"âŒ Ù†ØªÙˆØ§Ù†Ø³ØªÙ… Ø´Ù…Ø§ØªÛŒÚ© Ø±Ø§ Ø¨Ø³Ø§Ø²Ù…."); } return new Response("ok",{status:200}); }
if(wantsImage(text)){ const ok=await wikiFetchAndSend(text,token,chatId); if(ok) return new Response("ok",{status:200}); }
const res=await aiAnswerText(text,env); await sendMessage(token,chatId,res); return new Response("ok",{status:200}); }