import { oaiText, oaiVision } from "./openai.js"; import { hfText, hfVision } from "./huggingface.js"; import { cfText, cfVision } from "./cloudflare.js"; import { orText, orVision } from "./openrouter.js"; import { nextToken } from "../utils/rr.js"; import { getCfg } from "../utils/kv.js";
const MODELS={ text:{ openai:"gpt-4o-mini", hf:"HuggingFaceH4/zephyr-7b-beta", cf:"@cf/meta/llama-3.1-8b-instruct", or:"meta-llama/llama-3.1-8b-instruct:free" }, vision:{ openai:"gpt-4o-mini", hf:"llava-hf/llava-v1.6-mistral-7b", cf:"@cf/qwen/qwen2.5-vl-7b-instruct", or:"qwen/qwen2.5-vl-7b-instruct:free" } };
const DEFAULT_PROMPT=`You are "Saeed", a friendly electronics tutor for kids (10-15).
Answer ONLY electronics-related questions (components, circuits, laws: Ohm, Kirchhoff, filters, op-amps, Arduino basics, sensors, power, safety).
If the question is not about electronics, reply in Persian: "من فقط به پرسش‌های الکترونیک پاسخ می‌دهم."
Keep answers short, clear, with simple steps. If formulas are used, show them cleanly. Avoid unsafe instructions; warn about safety.`;
export async function getPrompt(env){ return (await getCfg(env,"PROMPT"))||DEFAULT_PROMPT; }
export async function runText(env,input){ const sys=await getPrompt(env); const order=["openai","hf","cf","or"]; const m=MODELS.text; for(const p of order){ try{ if(p==="openai"){ const key=await nextToken(env,"OPENAI"); if(!key) throw new Error("no OAI key"); return await oaiText(key,m.openai,input,sys);} if(p==="hf"){ const key=await nextToken(env,"HF"); if(!key) throw new Error("no HF token"); return await hfText(key,m.hf,input,sys);} if(p==="cf"){ if(!env.AI) throw new Error("no CF AI bind"); return await cfText(env.AI,m.cf,input,sys);} if(p==="or"){ const key=await nextToken(env,"OR"); if(!key) throw new Error("no OR key"); return await orText(key,m.or,input,sys);} }catch(e){} } return "❌ همهٔ مدل‌ها در دسترس نیستند."; }
export async function runVision(env,imageUrl,input){ const sys=await getPrompt(env); const order=["openai","hf","cf","or"]; const m=MODELS.vision; for(const p of order){ try{ if(p==="openai"){ const key=await nextToken(env,"OPENAI"); if(!key) throw new Error("no OAI key"); return await oaiVision(key,m.openai,imageUrl,input,sys);} if(p==="hf"){ const key=await nextToken(env,"HF"); if(!key) throw new Error("no HF token"); return await hfVision(key,m.hf,imageUrl,input,sys);} if(p==="cf"){ if(!env.AI) throw new Error("no CF AI bind"); return await cfVision(env.AI,m.cf,imageUrl,input,sys);} if(p==="or"){ const key=await nextToken(env,"OR"); if(!key) throw new Error("no OR key"); return await orVision(key,m.or,imageUrl,input,sys);} }catch(e){} } return "❌ همهٔ مدل‌ها در دسترس نیستند."; }